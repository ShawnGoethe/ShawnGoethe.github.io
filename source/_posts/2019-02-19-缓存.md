---
title: 缓存
date: 2019-02-19 20:12:14
tags:
categories: 
- high_availability
---
# 缓存

## why

- 高性能

  例如：把查完的值缓存，下次直接访问

- 高并发

  例如：把请求排队

## difference（vs memcached)

| 特征     | redis                              | memchched |
| -------- | ---------------------------------- | --------- |
| 数据结构 | 更复杂的数据结构，更丰富的数据操作 |           |
| 集群     | 支持                               | 不支持    |
| 性能     | 单核                               | 多核      |

## redis线程模型

redis 内部使用文件事件处理器 `file event handler`，这个文件事件处理器是单线程的，所以 redis 才叫做单线程的模型。它采用 IO 多路复用机制同时监听多个 socket，根据 socket 上的事件来选择对应的事件处理器进行处理。

假设一个 Redis 服务器正在运作， 那么这个服务器的监听套接字的 `AE_READABLE` 事件应该正处于监听状态之下， 而该事件所对应的处理器为连接应答处理器。

如果这时有一个 Redis 客户端向服务器发起连接， 那么监听套接字将产生 `AE_READABLE` 事件， 触发连接应答处理器执行： 处理器会对客户端的连接请求进行应答， 然后创建客户端套接字， 以及客户端状态， 并将客户端套接字的 `AE_READABLE` 事件与命令请求处理器进行关联， 使得客户端可以向主服务器发送命令请求。

之后， 假设客户端向主服务器发送一个命令请求， 那么客户端套接字将产生 `AE_READABLE` 事件， 引发命令请求处理器执行， 处理器读取客户端的命令内容， 然后传给相关程序去执行。

![redis-single-thread-model](https://github.com/doocs/advanced-java/raw/master/images/redis-single-thread-model.png)

执行命令将产生相应的命令回复， 为了将这些命令回复传送回客户端， 服务器会将客户端套接字的 `AE_WRITABLE` 事件与命令回复处理器进行关联： 当客户端尝试读取命令回复的时候， 客户端套接字将产生 `AE_WRITABLE` 事件， 触发命令回复处理器执行， 当命令回复处理器将命令回复全部写入到套接字之后， 服务器就会解除客户端套接字的 `AE_WRITABLE` 事件与命令回复处理器之间的关联。

