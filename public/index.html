<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.8.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"zehai.info","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="会做饭的厨子">
<meta property="og:type" content="website">
<meta property="og:title" content="Zehai&#39;blog">
<meta property="og:url" content="http://zehai.info/index.html">
<meta property="og:site_name" content="Zehai&#39;blog">
<meta property="og:description" content="会做饭的厨子">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zehai&#39;blog">
<meta name="twitter:description" content="会做饭的厨子">

<link rel="canonical" href="http://zehai.info/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false
  };
</script>

  <title>Zehai'blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zehai'blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">94</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories<span class="badge">29</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags<span class="badge">28</span></a>

  </li>
        <li class="menu-item menu-item-mysql">

    <a href="/MySQL/" rel="section"><i class="fa fa-fw fa-database"></i>MySQL</a>

  </li>
        <li class="menu-item menu-item-redis">

    <a href="/Redis/" rel="section"><i class="fa fa-fw fa-rebel"></i>Redis</a>

  </li>
        <li class="menu-item menu-item-cnetwork">

    <a href="/cnetwork" rel="section"><i class="fa fa-fw fa-desktop"></i>CNetwork</a>

  </li>
        <li class="menu-item menu-item-structure">

    <a href="/Structure" rel="section"><i class="fa fa-fw fa-asterisk"></i>Structure</a>

  </li>
        <li class="menu-item menu-item-nodejs">

    <a href="/Nodejs" rel="section"><i class="fa fa-fw fa-code"></i>NodeJS</a>

  </li>
        <li class="menu-item menu-item-interview">

    <a href="/Interview" rel="section"><i class="fa fa-fw fa-commenting"></i>Interview</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-readme">

    <a href="/README/" rel="section"><i class="fa fa-fw fa-info"></i>README</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zehai.info/2020/05/29/2020-05-29-deno/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/23207152?s=460&v=4">
      <meta itemprop="name" content="Zhang Zehai">
      <meta itemprop="description" content="会做饭的厨子">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zehai'blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/29/2020-05-29-deno/" class="post-title-link" itemprop="url">deno</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-05-29 16:18:55" itemprop="dateCreated datePublished" datetime="2020-05-29T16:18:55+08:00">2020-05-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-30 09:40:04" itemprop="dateModified" datetime="2020-05-30T09:40:04+08:00">2020-05-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/nodejs/" itemprop="url" rel="index"><span itemprop="name">nodejs</span></a>
                </span>
            </span>

          
            <span id="/2020/05/29/2020-05-29-deno/" class="post-meta-item leancloud_visitors" data-flag-title="deno" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/05/29/2020-05-29-deno/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/05/29/2020-05-29-deno/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="0-Attention"><a href="#0-Attention" class="headerlink" title="0. Attention"></a>0. Attention</h1><p>本文为个人翻译，学习输出，仅供参考，欢迎指出理解不足之处</p>
<h1 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h1><h1 id="2-Getting-Started"><a href="#2-Getting-Started" class="headerlink" title="2.Getting Started"></a>2.Getting Started</h1><h2 id="2-1-Installation"><a href="#2-1-Installation" class="headerlink" title="2.1 Installation"></a>2.1 Installation</h2><h2 id="2-2-Setup-your-environment"><a href="#2-2-Setup-your-environment" class="headerlink" title="2.2 Setup your environment"></a>2.2 Setup your environment</h2><h2 id="2-3-First-steps"><a href="#2-3-First-steps" class="headerlink" title="2.3 First steps"></a>2.3 First steps</h2><h3 id="2-3-1-helloworld"><a href="#2-3-1-helloworld" class="headerlink" title="2.3.1 helloworld"></a>2.3.1 helloworld</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"Welcome to Deno 🦕"</span>);</span><br><span class="line">deno run https:<span class="comment">//deno.land/std/examples/welcome.ts</span></span><br></pre></td></tr></table></figure>
<h3 id="2-3-2-Make-http-request"><a href="#2-3-2-Make-http-request" class="headerlink" title="2.3.2 Make http request"></a>2.3.2 Make http request</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> url = Deno.args[<span class="number">0</span>];<span class="comment">//get url</span></span><br><span class="line"><span class="keyword">const</span> res = <span class="keyword">await</span> fetch(url);<span class="comment">//await response --&gt;res</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> body = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>(<span class="keyword">await</span> res.arrayBuffer());<span class="comment">//parse body as ArrayBuffer and convert into Uint8Array</span></span><br><span class="line"><span class="keyword">await</span> Deno.stdout.write(body);<span class="comment">//write body --&gt; stdout</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//run</span></span><br><span class="line"><span class="comment">//wrong cause no permision</span></span><br><span class="line">deno run https:<span class="comment">//deno.land/std/examples/curl.ts https://example.com</span></span><br><span class="line"><span class="comment">//right</span></span><br><span class="line">deno run --allow-net=example.com https:<span class="comment">//deno.land/std/examples/curl.ts https://example.com</span></span><br></pre></td></tr></table></figure>
<h3 id="2-3-3-reading-a-file"><a href="#2-3-3-reading-a-file" class="headerlink" title="2.3.3 reading a file"></a>2.3.3 reading a file</h3><p>deno提供非源自网络的api，这些可以在deno全局调用，由于目前没有web标准，所以deno就自己做了一套标准，以下示例filename–&gt;open–&gt;print</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> filenames = Deno.args;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> filename <span class="keyword">of</span> filenames) &#123;</span><br><span class="line">  <span class="keyword">const</span> file = <span class="keyword">await</span> Deno.open(filename);</span><br><span class="line">  <span class="keyword">await</span> Deno.copy(file, Deno.stdout);</span><br><span class="line">  file.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用了<strong>kernel-&gt;user-&gt;kernel</strong>的方式copy，保证数据<strong>一致性</strong></p>
<p>避免了常见的4次拷贝</p>
<ol>
<li>磁盘—–DMA—-&gt;页缓存（kernel）</li>
<li>页缓存(kernel)–&gt;用户缓存（user）</li>
<li>用户缓存（user）–&gt;socket缓冲区（kernel）</li>
<li>Socket(kernel)—DMA copy—&gt;network</li>
</ol>
<p>经过多次拷贝，缓存数据可能被修改，<strong>导致和原文件数据不一致</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deno run --allow-read https://deno.land/std/examples/cat.ts /etc/passwd</span><br></pre></td></tr></table></figure>
<h3 id="2-3-4-tcp-server"><a href="#2-3-4-tcp-server" class="headerlink" title="2.3.4 tcp server"></a>2.3.4 tcp server</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> hostname = <span class="string">"0.0.0.0"</span>;</span><br><span class="line"><span class="keyword">const</span> port = <span class="number">8080</span>;</span><br><span class="line"><span class="keyword">const</span> listener = Deno.listen(&#123; hostname, port &#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">`Listening on <span class="subst">$&#123;hostname&#125;</span>:<span class="subst">$&#123;port&#125;</span>`</span>);</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">await</span> (<span class="keyword">const</span> conn <span class="keyword">of</span> listener) &#123;</span><br><span class="line">  Deno.copy(conn, conn);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>未经允许不可访问网络，如果需要，则添加–allow-net</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deno run --allow-net https://deno.land/std/examples/echo_server.ts</span><br><span class="line">//shell netcat(nc)</span><br><span class="line">nc localhost 8080</span><br><span class="line">hello world//input</span><br></pre></td></tr></table></figure>
<h2 id="2-4-Permissions"><a href="#2-4-Permissions" class="headerlink" title="2.4 Permissions"></a>2.4 Permissions</h2><p>deno拥有严格的权限管理，除非你声明，否则deno不会有file network enviroment权限，赋予只读权限就不会有读写权限</p>
<h3 id="2-4-1-Permissions-list"><a href="#2-4-1-Permissions-list" class="headerlink" title="2.4.1 Permissions list"></a>2.4.1 Permissions list</h3><ul>
<li><strong>-A, –allow-all</strong> Allow all permissions. This disables all security.</li>
<li><strong>–allow-env</strong> Allow environment access for things like getting and setting of environment variables.</li>
<li><strong>–allow-hrtime</strong> Allow high resolution time measurement. High resolution time can be used in timing attacks and fingerprinting.</li>
<li><strong>–allow-net=\<allow-net></allow-net></strong> Allow network access. You can specify an optional, comma separated list of domains to provide a whitelist of allowed domains.</li>
<li><strong>–allow-plugin</strong> Allow loading plugins. Please note that –allow-plugin is an unstable feature.</li>
<li><strong>–allow-read=\<allow-read></allow-read></strong> Allow file system read access. You can specify an optional, comma separated list of directories or files to provide a whitelist of allowed file system access.</li>
<li><strong>–allow-run</strong> Allow running subprocesses. Be aware that subprocesses are not run in a sandbox and therefore do not have the same security restrictions as the deno process. Therefore, use with caution.</li>
<li><strong>–allow-write=\<allow-write></allow-write></strong> Allow file system write access. You can specify an optional, comma separated list of directories or files to provide a whitelist of allowed file system access.</li>
</ul>
<h3 id="2-4-2-Permission-whitelist"><a href="#2-4-2-Permission-whitelist" class="headerlink" title="2.4.2 Permission whitelist"></a>2.4.2 Permission whitelist</h3><p>通过白名单，实现更高粒度的权限控制</p>
<p>示例给予/usr权限，但访问/etc</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> deno run --allow-read=/usr https://deno.land/std/examples/cat.ts /etc/passwd</span><br><span class="line">error: Uncaught PermissionDenied: read access to "/etc/passwd", run again with the --allow-read flag</span><br><span class="line">► $deno$/dispatch_json.ts:40:11</span><br><span class="line">    at DenoError ($deno$/errors.ts:20:5)</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">//yes    </span><br><span class="line"><span class="meta">$</span> deno run --allow-read=/etc https://deno.land/std/examples/cat.ts /etc/passwd</span><br></pre></td></tr></table></figure>
<h3 id="2-4-3-Network-access"><a href="#2-4-3-Network-access" class="headerlink" title="2.4.3 Network access"></a>2.4.3 Network access</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> result = <span class="keyword">await</span> fetch(<span class="string">"https://deno.land/"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//run</span></span><br><span class="line">$ deno run --allow-net=github.com,deno.land fetch.ts<span class="comment">//failed</span></span><br><span class="line">$</span><br></pre></td></tr></table></figure>
<p>如果fetch.ts尝试与别的domain建立连接，process将会失败，使用<code>deno run --allow-net fetch.ts</code>则可以</p>
<h2 id="2-5-Using-TS"><a href="#2-5-Using-TS" class="headerlink" title="2.5 Using TS"></a>2.5 Using TS</h2><p>天生支持JS,TS，需要引入模块拓展，使用文件，或者url进行导入</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; Response &#125; <span class="keyword">from</span> <span class="string">"https://deno.land/std@0.53.0/http/server.ts"</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; queue &#125; <span class="keyword">from</span> <span class="string">"./collections.ts"</span>;</span><br></pre></td></tr></table></figure>
<h3 id="2-5-1-Using-external-type-definitions"><a href="#2-5-1-Using-external-type-definitions" class="headerlink" title="2.5.1 Using external type definitions"></a>2.5.1 Using external type definitions</h3><p>开箱即用的TS编译器，也依靠无扩展模块(extension-less modules)，node模块解析逻辑(module resolution logic)来实现将类型（tpyes）应用于JS模块，为了给TS与JS建立桥梁，支持三种引用类型定义文件的方式</p>
<ul>
<li><p>compiler hint</p>
</li>
<li><p>Triple-slash reference directive</p>
</li>
<li><h4 id="X-TypeScript-Types-custom-header"><a href="#X-TypeScript-Types-custom-header" class="headerlink" title="X-TypeScript-Types custom header"></a>X-TypeScript-Types custom header</h4></li>
</ul>
<p>Compiler hint ：当你知道文件位置时候引用,deno编译器会夹在foo.d.ts而不是foo.js</p>
<p>当运行时，Deno会一直加载foo.js</p>
<p><a href="https://deno.land/manual/getting_started/typescript#compiler-hint" target="_blank" rel="noopener">不全待补充</a></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @deno-types="./foo.d.ts"</span></span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> foo <span class="keyword">from</span> <span class="string">"./foo.js"</span>;</span><br></pre></td></tr></table></figure>
<p>不是所有定义都支持：deno会加载*.d.ts文件，但不是所有文件都支持，如访问:<code>./node_modules/@types/node/index.d.ts</code></p>
<p>为什么TS文件中不使用triple-slash type reference</p>
<p>如果使用，干扰TS编译器的行为，Deno尽在JS和JSX文件中查找指令</p>
<h3 id="2-5-2-Custom-TypeScript-Compiler-Options"><a href="#2-5-2-Custom-TypeScript-Compiler-Options" class="headerlink" title="2.5.2 Custom TypeScript Compiler Options"></a>2.5.2 Custom TypeScript Compiler Options</h3><p>Deno 默认开始严格模式，使用<code>tsconfig.ts</code>来配置，需要通过-c来告诉deno配置文件<code>deno run -c tsconfig.json mod.ts</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">//default optins</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"compilerOptions"</span>: &#123;</span><br><span class="line">    <span class="attr">"allowJs"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"allowUmdGlobalAccess"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"allowUnreachableCode"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"allowUnusedLabels"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"alwaysStrict"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"assumeChangesOnlyAffectDirectDependencies"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"checkJs"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"disableSizeLimit"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"generateCpuProfile"</span>: <span class="string">"profile.cpuprofile"</span>,</span><br><span class="line">    <span class="attr">"jsx"</span>: <span class="string">"react"</span>,</span><br><span class="line">    <span class="attr">"jsxFactory"</span>: <span class="string">"React.createElement"</span>,</span><br><span class="line">    <span class="attr">"lib"</span>: [],</span><br><span class="line">    <span class="attr">"noFallthroughCasesInSwitch"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"noImplicitAny"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"noImplicitReturns"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"noImplicitThis"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"noImplicitUseStrict"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"noStrictGenericChecks"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"noUnusedLocals"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"noUnusedParameters"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"preserveConstEnums"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"removeComments"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"resolveJsonModule"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"strict"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"strictBindCallApply"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"strictFunctionTypes"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"strictNullChecks"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"strictPropertyInitialization"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">"suppressExcessPropertyErrors"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"suppressImplicitAnyIndexErrors"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"useDefineForClassFields"</span>: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-6-Using-WebAssembly"><a href="#2-6-Using-WebAssembly" class="headerlink" title="2.6 Using WebAssembly"></a>2.6 Using WebAssembly</h2><p>deno可以执行<code>wasm</code>二进制文件</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> wasmCode = <span class="keyword">new</span> <span class="built_in">Uint8Array</span>([</span><br><span class="line">  <span class="number">0</span>, <span class="number">97</span>, <span class="number">115</span>, <span class="number">109</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">133</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">96</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">127</span>,</span><br><span class="line">  <span class="number">3</span>, <span class="number">130</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">112</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">  <span class="number">5</span>, <span class="number">131</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">129</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">7</span>, <span class="number">145</span>,</span><br><span class="line">  <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">6</span>, <span class="number">109</span>, <span class="number">101</span>, <span class="number">109</span>, <span class="number">111</span>, <span class="number">114</span>, <span class="number">121</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">109</span>, <span class="number">97</span>,</span><br><span class="line">  <span class="number">105</span>, <span class="number">110</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>, <span class="number">138</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">132</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">0</span>,</span><br><span class="line">  <span class="number">65</span>, <span class="number">42</span>, <span class="number">11</span></span><br><span class="line">]);</span><br><span class="line"><span class="keyword">const</span> wasmModule = <span class="keyword">new</span> WebAssembly.Module(wasmCode);</span><br><span class="line"><span class="keyword">const</span> wasmInstance = <span class="keyword">new</span> WebAssembly.Instance(wasmModule);</span><br><span class="line"><span class="built_in">console</span>.log(wasmInstance.exports.main().toString());</span><br></pre></td></tr></table></figure>
<h1 id="3-The-Runtime"><a href="#3-The-Runtime" class="headerlink" title="3. The Runtime"></a>3. The Runtime</h1><p>Runtime functions(web Apis + deco global)</p>
<h2 id="3-1-Stability"><a href="#3-1-Stability" class="headerlink" title="3.1 Stability"></a>3.1 Stability</h2><p>自1.0.0版本后，各API趋于稳定，但并非所有的API都可以投入prod使用，使用–unstable解除锁定</p>
<h2 id="3-2-Program-lifecycle"><a href="#3-2-Program-lifecycle" class="headerlink" title="3.2 Program lifecycle"></a>3.2 Program lifecycle</h2><p>deno支持与浏览器兼容的生命周期events，<code>load</code> and <code>unload</code></p>
<p>你可以使用这些events，在你的程序中提供 setup/cleanup code</p>
<p>load 是异步的，等待的，<strong>不可取消的</strong></p>
<p>unload是同步的，<strong>不可取消的</strong></p>
<p><strong>main.ts</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">"./imported.ts"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> handler = (e: Event): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`got <span class="subst">$&#123;e.type&#125;</span> event in event handler (main)`</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">"load"</span>, handler);</span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">"unload"</span>, handler);</span><br><span class="line"><span class="built_in">window</span>.onload = (e: Event): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`got <span class="subst">$&#123;e.type&#125;</span> event in onload function (main)`</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">window</span>.onunload = (e: Event): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`got <span class="subst">$&#123;e.type&#125;</span> event in onunload function (main)`</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"log from main script"</span>);</span><br></pre></td></tr></table></figure>
<p><strong>imported.ts</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> handler = (e: Event): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`got <span class="subst">$&#123;e.type&#125;</span> event in event handler (imported)`</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">"load"</span>, handler);</span><br><span class="line"><span class="built_in">window</span>.addEventListener(<span class="string">"unload"</span>, handler);</span><br><span class="line"><span class="built_in">window</span>.onload = (e: Event): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`got <span class="subst">$&#123;e.type&#125;</span> event in onload function (imported)`</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">window</span>.onunload = (e: Event): <span class="function"><span class="params">void</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`got <span class="subst">$&#123;e.type&#125;</span> event in onunload function (imported)`</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"log from imported script"</span>);</span><br></pre></td></tr></table></figure>
<p>run</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> deno run main.ts</span><br><span class="line">log from imported script</span><br><span class="line">log from main script</span><br><span class="line">got load event in onload function (main)</span><br><span class="line">got load event in event handler (imported)</span><br><span class="line">got load event in event handler (main)</span><br><span class="line">got unload event in onunload function (main)</span><br><span class="line">got unload event in event handler (imported)</span><br><span class="line">got unload event in event handler (main)</span><br></pre></td></tr></table></figure>
<p>Importes.ts的方法被main覆盖</p>
<h2 id="3-3-Compiler-APIs"><a href="#3-3-Compiler-APIs" class="headerlink" title="3.3 Compiler APIs"></a>3.3 Compiler APIs</h2><p>目前编译器的apis是unstable的，deno支持对内置ts编译器runtime的访问，有三种方法访问</p>
<ul>
<li>Deno.complie()</li>
<li>Deno.bundle()</li>
<li>Deno.transpileOnly()</li>
</ul>
<h3 id="3-3-1-Referencing-TypeScipt-library-files"><a href="#3-3-1-Referencing-TypeScipt-library-files" class="headerlink" title="3.3.1 Referencing TypeScipt library files"></a>3.3.1 Referencing TypeScipt library files</h3><h2 id="3-4-Workers"><a href="#3-4-Workers" class="headerlink" title="3.4 Workers"></a>3.4 Workers</h2><p>deno支持web worker api</p>
<p>worker可以在多线程上运行代码，每个worker实例在单独专用的线程上运行，目前仅支持<code>module</code>类型的worker</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Good</span></span><br><span class="line"><span class="keyword">new</span> Worker(<span class="string">"./worker.js"</span>, &#123; <span class="keyword">type</span>: <span class="string">"module"</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Bad</span></span><br><span class="line"><span class="keyword">new</span> Worker(<span class="string">"./worker.js"</span>);</span><br><span class="line"><span class="keyword">new</span> Worker(<span class="string">"./worker.js"</span>, &#123; <span class="keyword">type</span>: <span class="string">"classic"</span> &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="3-4-1-Permissions"><a href="#3-4-1-Permissions" class="headerlink" title="3.4.1 Permissions"></a>3.4.1 Permissions</h3><p>创建新的worker是动态导入，需要赋予权限</p>
<p><strong>main.ts</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> Worker(<span class="string">"./worker.ts"</span>, &#123; <span class="keyword">type</span>: <span class="string">"module"</span> &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>worker.ts</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="string">"hello world"</span>);</span><br><span class="line">self.close();</span><br><span class="line">---</span><br><span class="line">$ deno run main.ts</span><br><span class="line">error: Uncaught PermissionDenied: read access to <span class="string">"./worker.ts"</span>, run again <span class="keyword">with</span> the --allow-read flag</span><br><span class="line">$ deno run --allow-read main.ts</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>
<p>For workers using remote modules; <code>--allow-net</code> permission is required:</p>
<h3 id="3-4-2-Using-Deno-in-worker"><a href="#3-4-2-Using-Deno-in-worker" class="headerlink" title="3.4.2 Using Deno in worker"></a>3.4.2 Using Deno in worker</h3><p><strong>main.js</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> worker = <span class="keyword">new</span> Worker(<span class="string">"./worker.js"</span>, &#123; <span class="keyword">type</span>: <span class="string">"module"</span>, deno: <span class="literal">true</span> &#125;);</span><br><span class="line">worker.postMessage(&#123; filename: <span class="string">"./log.txt"</span> &#125;);</span><br></pre></td></tr></table></figure>
<p><strong>worker.js</strong></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">self.onmessage = <span class="keyword">async</span> (e) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; filename &#125; = e.data;</span><br><span class="line">  <span class="keyword">const</span> text = <span class="keyword">await</span> Deno.readTextFile(filename);</span><br><span class="line">  <span class="built_in">console</span>.log(text);</span><br><span class="line">  self.close();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>log.txt</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hello world</span><br><span class="line">$ deno run --allow-read --unstable main.js</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>
<h1 id="4-Linking-to-external-code"><a href="#4-Linking-to-external-code" class="headerlink" title="4. Linking to external code"></a>4. Linking to external code</h1><h1 id="5-Standard-library"><a href="#5-Standard-library" class="headerlink" title="5. Standard library"></a>5. Standard library</h1><h1 id="6-Testing"><a href="#6-Testing" class="headerlink" title="6. Testing"></a>6. Testing</h1><h1 id="7-Tools"><a href="#7-Tools" class="headerlink" title="7. Tools"></a>7. Tools</h1><h1 id="8-Embedding-Deno"><a href="#8-Embedding-Deno" class="headerlink" title="8. Embedding Deno"></a>8. Embedding Deno</h1><h1 id="9-Contributing"><a href="#9-Contributing" class="headerlink" title="9. Contributing"></a>9. Contributing</h1><h1 id="10-Examples"><a href="#10-Examples" class="headerlink" title="10. Examples"></a>10. Examples</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zehai.info/2020/05/13/2020-05-13-监控软件/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/23207152?s=460&v=4">
      <meta itemprop="name" content="Zhang Zehai">
      <meta itemprop="description" content="会做饭的厨子">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zehai'blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/13/2020-05-13-监控软件/" class="post-title-link" itemprop="url">monit</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-05-13 16:18:55" itemprop="dateCreated datePublished" datetime="2020-05-13T16:18:55+08:00">2020-05-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-30 09:39:47" itemprop="dateModified" datetime="2020-05-30T09:39:47+08:00">2020-05-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/monit/" itemprop="url" rel="index"><span itemprop="name">monit</span></a>
                </span>
            </span>

          
            <span id="/2020/05/13/2020-05-13-监控软件/" class="post-meta-item leancloud_visitors" data-flag-title="monit" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/05/13/2020-05-13-监控软件/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/05/13/2020-05-13-监控软件/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>监控</p>
<h1 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h1><p>prometheus vs zabbix</p>
<p>先对两者的各自特点进行一下对比：</p>
<table>
<thead>
<tr>
<th>Zabbix</th>
<th>Prometheus</th>
</tr>
</thead>
<tbody>
<tr>
<td>后端用 C 开发，界面用 PHP 开发，定制化难度很高。</td>
<td>后端用 golang 开发，前端是 Grafana，JSON 编辑即可解决。定制化难度较低。</td>
</tr>
<tr>
<td>集群规模上限为 10000 个节点。</td>
<td>支持更大的集群规模，速度也更快。</td>
</tr>
<tr>
<td>更适合监控物理机环境。</td>
<td>更适合云环境的监控，对 OpenStack，<strong>Kubernetes</strong> 有更好的集成。</td>
</tr>
<tr>
<td>监控数据存储在关系型数据库内，如 MySQL，很难从现有数据中扩展维度。</td>
<td>监控数据存储在基于<strong>时间序列(TSDB)</strong>的数据库内，便于对已有数据进行新的聚合。</td>
</tr>
<tr>
<td>安装简单，zabbix-server 一个软件包中包括了所有的服务端功能。</td>
<td>安装相对复杂，<strong>监控、告警和界面</strong>都分属于不同的组件。</td>
</tr>
<tr>
<td><strong>图形化界面</strong>比较成熟，界面上基本上能完成全部的配置操作。</td>
<td>界面相对较弱，很多配置需要修改配置文件。</td>
</tr>
<tr>
<td>发展时间更长，对于很多监控场景，都有现成的解决方案。</td>
<td>2015 年后开始快速发展，但发展时间较短，成熟度不及 Zabbix。</td>
</tr>
</tbody>
</table>
<p>由于最后敲定了Prometheus方案，对于zabbix就云评测了，欢迎指正</p>
<ul>
<li>虽然图形化界面弱化，很多配置走yml文件，但图形化界面真的没有必要</li>
<li>时序数据库，高并发下好于mysql（不然干嘛开发tsdb应对监控场景）</li>
<li>prom支持pull和push模型，可以支持k8s，swarm等服务发现</li>
</ul>
<h1 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h1><p>Performance？webVitals？以后用到再补充</p>
<p>主要关注性能，pv，redirect，err等问题</p>
<h1 id="页面是否可用"><a href="#页面是否可用" class="headerlink" title="页面是否可用"></a>页面是否可用</h1><p>阿里云-云监控控制台</p>
<p>可提供网址监控，包括cookie, headers 等自定义的简单配置，进行电话，邮件，短信，旺旺等报警</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zehai.info/2020/05/12/2020-05-12-paddle/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/23207152?s=460&v=4">
      <meta itemprop="name" content="Zhang Zehai">
      <meta itemprop="description" content="会做饭的厨子">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zehai'blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/05/12/2020-05-12-paddle/" class="post-title-link" itemprop="url">pandle</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-05-12 16:18:55" itemprop="dateCreated datePublished" datetime="2020-05-12T16:18:55+08:00">2020-05-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-30 09:40:04" itemprop="dateModified" datetime="2020-05-30T09:40:04+08:00">2020-05-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/pandle/" itemprop="url" rel="index"><span itemprop="name">pandle</span></a>
                </span>
            </span>

          
            <span id="/2020/05/12/2020-05-12-paddle/" class="post-meta-item leancloud_visitors" data-flag-title="pandle" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/05/12/2020-05-12-paddle/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/05/12/2020-05-12-paddle/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="start"><a href="#start" class="headerlink" title="start"></a>start</h1><p>use docker</p>
<h1 id="platform"><a href="#platform" class="headerlink" title="platform"></a>platform</h1><ul>
<li><strong>AI Studio</strong>：<a href="https://aistudio.baidu.com/" target="_blank" rel="noopener">https://aistudio.baidu.com/</a></li>
<li><strong>飞桨官网</strong>：<a href="https://www.paddlepaddle.org.cn/" target="_blank" rel="noopener">https://www.paddlepaddle.org.cn/</a></li>
<li><strong>百度技术学院</strong>：<a href="http://bit.baidu.com/index" target="_blank" rel="noopener">http://bit.baidu.com/index</a></li>
</ul>
<h1 id="about"><a href="#about" class="headerlink" title="about"></a>about</h1><p>人工智能&gt;机器学习&gt;深度学习</p>
<ul>
<li><p>人工智能是研发用于模拟、延伸和扩展人的智能的理论、方法、技术及应用系统的一门新的技术科学。由于这个定义只阐述了目标，而没有限定方法，因此实现人工智能存在的诸多方法和分支，导致其变成一个“大杂烩”式的学科。</p>
</li>
<li><p>机器学习、尤其是监督学习则有更加明确的指代。机器学习是专门研究计算机怎样模拟或实现人类的学习行为，以获取新的知识或技能，重新组织已有的知识结构，使之不断改善自身的性能</p>
</li>
<li><p>多数机器学习任务都可以使用深度学习模型解决，尤其在在语音、计算机视觉和自然语言处理等领域，深度学习模型的效果比传统机器学习算法有显著提升。</p>
<p>那么相比传统的机器学习算法，深度学习做出了改进，<strong>两者在理论结构上是一致的，即：模型假设、评价函数和优化算法，其根本差别在于假设的复杂度</strong></p>
</li>
</ul>
<p>人工神经网络包括多个神经网络层，如卷积层、全连接层、LSTM等，每一层又包括很多神经元，超过三层的非线性神经网络都可以被称为深度神经网络。通俗的讲，深度学习的模型可以视为是输入到输出的映射函数，如图像到高级语义（美女）的映射，足够深的神经网络理论上可以拟合任何复杂的函数。因此神经网络非常适合学习样本数据的内在规律和表示层次，对文字、图像和语音任务有很好的适用性。因为这几个领域的任务是人工智能的基础模块，所以深度学习被称为实现人工智能的基础也就不足为奇了。</p>
<ul>
<li>神经元：神经网络中每个节点称为神经元，由两部分组成：<ul>
<li>加权和：将所有输入加权求和。</li>
<li>非线性变换（激活函数）：加权和的结果经过一个非线性函数变换，让神经元计算具备非线性的能力。</li>
</ul>
</li>
<li><strong>多层连接：</strong> 大量这样的节点按照不同的层次排布，形成多层的结构连接起来，即称为神经网络。</li>
<li><strong>前向计算：</strong> 从输入计算输出的过程，顺序从网络前至后。</li>
<li><strong>计算图：</strong> 以图形化的方式展现神经网络的计算逻辑又成为计算图。我们也可以将神经网络的计算图以公式的方式表达如下：</li>
</ul>
<p>由此可见，神经网络并没有那么神秘，它的本质是一个含有很多参数的“大公式”。</p>
<p>深度学习框架标准化，自动化，模块化</p>
<p>数据处理-&gt;模型设计-&gt;训练配置-&gt;训练过程-&gt;模型保存</p>
<ul>
<li>数据处理：数据导入–&gt;数据形状变换–&gt;数据集划分–&gt;数据归一化处理–&gt;封装load data数据–&gt;数据预处理–&gt;模型调用</li>
</ul>
<h1 id="构建神经网络模型"><a href="#构建神经网络模型" class="headerlink" title="构建神经网络模型"></a>构建神经网络模型</h1><p>神经网络的基本概念（如神经元、多层连接、前向计算、计算图）和模型结构三要素（模型假设、评价函数和优化算法）</p>
<p>连续–&gt;回归任务</p>
<p>离散–&gt;分类任务</p>
<p>数据处理（数据导入、数据形状变换、数据集划分、数据归一化处理，封装load data函数）-&gt;模型设计-&gt;训练配置-&gt;训练过程-&gt;模型保存</p>
<h2 id="数据处理"><a href="#数据处理" class="headerlink" title="数据处理"></a>数据处理</h2><p>1.数据导入</p>
<p>2.数据形状变换（1维数据改成可用形式）</p>
<p>3.数据集划分，划分训练集，测试集</p>
<p>4.数据归一化（特征值0～1）</p>
<p>5.封装load data函数</p>
<h2 id="模型设计"><a href="#模型设计" class="headerlink" title="模型设计"></a>模型设计</h2><p>模型设计是深度学习模型关键要素之一，也称为网络结构设计，相当于模型的假设空间，即实现模型“前向计算”（从输入到输出）的过程。</p>
<h2 id="提督下降算法"><a href="#提督下降算法" class="headerlink" title="提督下降算法"></a>提督下降算法</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zehai.info/2020/04/30/2020-04-30-prom-client/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/23207152?s=460&v=4">
      <meta itemprop="name" content="Zhang Zehai">
      <meta itemprop="description" content="会做饭的厨子">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zehai'blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/30/2020-04-30-prom-client/" class="post-title-link" itemprop="url">prom-client</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-30 16:18:55" itemprop="dateCreated datePublished" datetime="2020-04-30T16:18:55+08:00">2020-04-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-30 09:40:04" itemprop="dateModified" datetime="2020-05-30T09:40:04+08:00">2020-05-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/prometheus/" itemprop="url" rel="index"><span itemprop="name">prometheus</span></a>
                </span>
            </span>

          
            <span id="/2020/04/30/2020-04-30-prom-client/" class="post-meta-item leancloud_visitors" data-flag-title="prom-client" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/04/30/2020-04-30-prom-client/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/04/30/2020-04-30-prom-client/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>prom-clinet</p>
<p>prometheus的client，支持histogram summaries gauges counters</p>
<h1 id="usage"><a href="#usage" class="headerlink" title="usage"></a>usage</h1><ul>
<li>cluster模式,避免各个worker都有一个metric</li>
<li>非cluster模式，全局挂载</li>
</ul>
<h1 id="api"><a href="#api" class="headerlink" title="api"></a>api</h1><h2 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h2><p>所有metric都有两个强制属性</p>
<ul>
<li>name</li>
<li>help（描述）</li>
</ul>
<h2 id="DefaultMetrics"><a href="#DefaultMetrics" class="headerlink" title="DefaultMetrics"></a>DefaultMetrics</h2><p>collectDefaultMetrics({options})</p>
<p>Options （Object）具备以下四个参数</p>
<ul>
<li>prefix：metric添加前缀 ，默认没有前缀（job instance后更加细分）</li>
<li>registry:指向哪个register，默认全局</li>
<li>gcDurationBuckets 自定义buckets的gc持续时间直方图，默认[0.001, 0.01, 0.1, 1, 2, 5]` (in seconds).</li>
<li>eventLoopMonitoringPrecision 采样率以毫秒为单位（&gt;0），默认10</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> client = <span class="built_in">require</span>(<span class="string">'prom-client'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> collectDefaultMetrics = client.collectDefaultMetrics;</span><br><span class="line"><span class="keyword">const</span> Registry = client.Registry;</span><br><span class="line"><span class="keyword">const</span> register = <span class="keyword">new</span> Registry();</span><br><span class="line"><span class="keyword">const</span> prefix = <span class="string">'my_application_'</span>;</span><br><span class="line"></span><br><span class="line">collectDefaultMetrics(&#123; register,prefix,<span class="attr">gcDurationBuckets</span>: [<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.3</span>] &#125;);</span><br></pre></td></tr></table></figure>
<h2 id="counter"><a href="#counter" class="headerlink" title="counter"></a>counter</h2><p>当进程重启时，counter会清空，使用函数解决</p>
<p>作者注：</p>
<ul>
<li>可以监控按钮点击次数，请求次数来监控业务数据</li>
<li>同时也<strong>支持labelNames</strong>，参考Histogram</li>
<li>从0开始增，<strong>不可减</strong>，（减-&gt;gauge）</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> client = <span class="built_in">require</span>(<span class="string">'prom-client'</span>);</span><br><span class="line"><span class="keyword">const</span> counter = <span class="keyword">new</span> client.Counter(&#123;</span><br><span class="line">  name: <span class="string">'metric_name'</span>,</span><br><span class="line">  help: <span class="string">'metric_help'</span>,</span><br><span class="line">&#125;);</span><br><span class="line">counter.inc(); <span class="comment">// Inc with 1</span></span><br><span class="line">counter.inc(<span class="number">10</span>); <span class="comment">// Inc with 10</span></span><br></pre></td></tr></table></figure>
<h2 id="gauge"><a href="#gauge" class="headerlink" title="gauge"></a>gauge</h2><p>counter功能基础上支持减法</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//base</span></span><br><span class="line"><span class="keyword">const</span> client = <span class="built_in">require</span>(<span class="string">'prom-client'</span>);</span><br><span class="line"><span class="keyword">const</span> gauge = <span class="keyword">new</span> client.Gauge(&#123; <span class="attr">name</span>: <span class="string">'metric_name'</span>, <span class="attr">help</span>: <span class="string">'metric_help'</span> &#125;);</span><br><span class="line">gauge.set(<span class="number">10</span>); <span class="comment">// Set to 10</span></span><br><span class="line">gauge.inc(); <span class="comment">// Inc with 1</span></span><br><span class="line">gauge.inc(<span class="number">10</span>); <span class="comment">// Inc with 10</span></span><br><span class="line">gauge.dec(); <span class="comment">// Dec with 1</span></span><br><span class="line">gauge.dec(<span class="number">10</span>); <span class="comment">// Dec with 10</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//others</span></span><br><span class="line">gauge.setToCurrentTime(); <span class="comment">// Sets value to current time</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> end = gauge.startTimer();</span><br><span class="line">xhrRequest(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">  end(); <span class="comment">// Sets value to xhrRequests duration in seconds</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="histogram"><a href="#histogram" class="headerlink" title="histogram"></a>histogram</h2><p>追踪事件的大小和频率</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>默认的buckets旨在覆盖常规的web/rpc请求，也可以被override</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> client = <span class="built_in">require</span>(<span class="string">'prom-client'</span>);</span><br><span class="line"><span class="keyword">new</span> client.Histogram(&#123;</span><br><span class="line">  name: <span class="string">'metric_name'</span>,</span><br><span class="line">  help: <span class="string">'metric_help'</span>,</span><br><span class="line">  labelNames: [<span class="string">'status_code'</span>],<span class="comment">//**Array**</span></span><br><span class="line">  buckets: [<span class="number">0.1</span>, <span class="number">5</span>, <span class="number">15</span>, <span class="number">50</span>, <span class="number">100</span>, <span class="number">500</span>],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> client = <span class="built_in">require</span>(<span class="string">'prom-client'</span>);</span><br><span class="line"><span class="keyword">const</span> histogram = <span class="keyword">new</span> client.Histogram(&#123;</span><br><span class="line">  name: <span class="string">'metric_name'</span>,</span><br><span class="line">  help: <span class="string">'metric_help'</span>,</span><br><span class="line">&#125;);</span><br><span class="line">histogram.observe(<span class="number">10</span>); <span class="comment">// Observe value in histogram</span></span><br></pre></td></tr></table></figure>
<h3 id="Utility-to-observe-request-durations"><a href="#Utility-to-observe-request-durations" class="headerlink" title="Utility to observe request durations"></a>Utility to observe request durations</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> end = histogram.startTimer();</span><br><span class="line">xhrRequest(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> seconds = end(); <span class="comment">// Observes and returns the value to xhrRequests duration in seconds</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>计算观察值的百分比数据</p>
<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h3><p>默认百分比[0.01, 0.05, 0.5, 0.9, 0.95, 0.99, 0.999]，但可以被覆盖</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> client = <span class="built_in">require</span>(<span class="string">'prom-client'</span>);</span><br><span class="line"><span class="keyword">new</span> client.Summary(&#123;</span><br><span class="line">  name: <span class="string">'metric_name'</span>,</span><br><span class="line">  help: <span class="string">'metric_help'</span>,</span><br><span class="line">  percentiles: [<span class="number">0.01</span>, <span class="number">0.1</span>, <span class="number">0.9</span>, <span class="number">0.99</span>],</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>如果启用滑动窗口功能，需要新增<code>maxAgeSeconds</code> and <code>ageBuckets</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> client = <span class="built_in">require</span>(<span class="string">'prom-client'</span>);</span><br><span class="line"><span class="keyword">new</span> client.Summary(&#123;</span><br><span class="line">  name: <span class="string">'metric_name'</span>,</span><br><span class="line">  help: <span class="string">'metric_help'</span>,</span><br><span class="line">  maxAgeSeconds: <span class="number">600</span>,</span><br><span class="line">  ageBuckets: <span class="number">5</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>maxAgeSeconds 可以知道bucket重制前的使用时常</p>
<p>ageBuckets 滑动窗口中最多的buckets数目</p>
<h3 id="Usage-example"><a href="#Usage-example" class="headerlink" title="Usage example"></a>Usage example</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> client = <span class="built_in">require</span>(<span class="string">'prom-client'</span>);</span><br><span class="line"><span class="keyword">const</span> summary = <span class="keyword">new</span> client.Summary(&#123;</span><br><span class="line">  name: <span class="string">'metric_name'</span>,</span><br><span class="line">  help: <span class="string">'metric_help'</span>,</span><br><span class="line">&#125;);</span><br><span class="line">summary.observe(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>
<h3 id="Utility-to-observe-request-durations-1"><a href="#Utility-to-observe-request-durations-1" class="headerlink" title="Utility to observe request durations"></a>Utility to observe request durations</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> end = summary.startTimer();</span><br><span class="line">xhrRequest(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">  end(); <span class="comment">// Observes the value to xhrRequests duration in seconds</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="labels"><a href="#labels" class="headerlink" title="labels"></a>labels</h2><p>所有metrics可以设置labelNames属性，两种赋值方式</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> client = <span class="built_in">require</span>(<span class="string">'prom-client'</span>);</span><br><span class="line"><span class="keyword">const</span> gauge = <span class="keyword">new</span> client.Gauge(&#123;</span><br><span class="line">  name: <span class="string">'metric_name'</span>,</span><br><span class="line">  help: <span class="string">'metric_help'</span>,</span><br><span class="line">  labelNames: [<span class="string">'method'</span>, <span class="string">'statusCode'</span>],</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">gauge.set(&#123; <span class="attr">method</span>: <span class="string">'GET'</span>, <span class="attr">statusCode</span>: <span class="string">'200'</span> &#125;, <span class="number">100</span>); <span class="comment">// 1st version, Set value 100 with method set to GET and statusCode to 200</span></span><br><span class="line">gauge.labels(<span class="string">'GET'</span>, <span class="string">'200'</span>).set(<span class="number">100</span>); <span class="comment">// 2nd version, Same as above</span></span><br></pre></td></tr></table></figure>
<p>用来记录请求结果</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> end = startTimer(&#123; <span class="attr">method</span>: <span class="string">'GET'</span> &#125;); <span class="comment">// Set method to GET, we don't know statusCode yet</span></span><br><span class="line">xhrRequest(<span class="function"><span class="keyword">function</span> (<span class="params">err, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (err) &#123;</span><br><span class="line">    end(&#123; <span class="attr">statusCode</span>: <span class="string">'500'</span> &#125;); <span class="comment">// Sets value to xhrRequest duration in seconds with statusCode 500</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    end(&#123; <span class="attr">statusCode</span>: <span class="string">'200'</span> &#125;); <span class="comment">// Sets value to xhrRequest duration in seconds with statusCode 200</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="default-labels"><a href="#default-labels" class="headerlink" title="default labels"></a>default labels</h3><h1 id="gc"><a href="#gc" class="headerlink" title="gc"></a>gc</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zehai.info/2020/04/30/2020-04-30-prometheus/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/23207152?s=460&v=4">
      <meta itemprop="name" content="Zhang Zehai">
      <meta itemprop="description" content="会做饭的厨子">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zehai'blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/30/2020-04-30-prometheus/" class="post-title-link" itemprop="url">prometheus</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-30 16:18:55" itemprop="dateCreated datePublished" datetime="2020-04-30T16:18:55+08:00">2020-04-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-30 09:40:04" itemprop="dateModified" datetime="2020-05-30T09:40:04+08:00">2020-05-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/prometheus/" itemprop="url" rel="index"><span itemprop="name">prometheus</span></a>
                </span>
            </span>

          
            <span id="/2020/04/30/2020-04-30-prometheus/" class="post-meta-item leancloud_visitors" data-flag-title="prometheus" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/04/30/2020-04-30-prometheus/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/04/30/2020-04-30-prometheus/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="1-Introduction"><a href="#1-Introduction" class="headerlink" title="1. Introduction"></a>1. Introduction</h1><h1 id="2-Concepts"><a href="#2-Concepts" class="headerlink" title="2.Concepts"></a>2.Concepts</h1><h1 id="3-Prometheus"><a href="#3-Prometheus" class="headerlink" title="3. Prometheus"></a>3. Prometheus</h1><h1 id="4-Visualization"><a href="#4-Visualization" class="headerlink" title="4.Visualization"></a>4.Visualization</h1><h1 id="5-Operating"><a href="#5-Operating" class="headerlink" title="5.Operating"></a>5.Operating</h1><h2 id="5-1security"><a href="#5-1security" class="headerlink" title="5.1security"></a>5.1security</h2><p>promethues具备很多组件，以及与其他系统集成，本身<strong>可以</strong>部署在受信任和不受信任的环境</p>
<h3 id="5-1-1-Promethues"><a href="#5-1-1-Promethues" class="headerlink" title="5.1.1 Promethues"></a>5.1.1 Promethues</h3><h3 id="5-1-2-AlertManager"><a href="#5-1-2-AlertManager" class="headerlink" title="5.1.2 AlertManager"></a>5.1.2 AlertManager</h3><h3 id="5-1-3-Pushgateway"><a href="#5-1-3-Pushgateway" class="headerlink" title="5.1.3 Pushgateway"></a>5.1.3 Pushgateway</h3><h3 id="5-1-4-Exporters"><a href="#5-1-4-Exporters" class="headerlink" title="5.1.4 Exporters"></a>5.1.4 Exporters</h3><h3 id="5-1-5-Client-Libraries"><a href="#5-1-5-Client-Libraries" class="headerlink" title="5.1.5 Client Libraries"></a>5.1.5 Client Libraries</h3><h3 id="5-1-6-Auth-and-encrytion"><a href="#5-1-6-Auth-and-encrytion" class="headerlink" title="5.1.6 Auth and encrytion"></a>5.1.6 Auth and encrytion</h3><p>prometheus 及其组建不提供任何身份验证（server-side authentication）,授权（authorization） ,加密（encryption）</p>
<p>如果需要，建议采用<code>反向代理</code></p>
<ul>
<li><p>在管理或者mutating endpoints 使用简单的访问工具（如cURL）访问，由于prom没有内置的csrf保护模块，所以会破坏类用例（break such use cases）,因此使用反向代理，可以避免csrf攻击</p>
</li>
<li><p>对于非mutating endpoints ，你可以使用cors headers （如<code>Access-Control-Allow-Origin</code>）来避免xss攻击</p>
</li>
<li><p>对于非信任用户，使用转译</p>
</li>
<li>对于grafana，做好权限监控，不要限制使用代理方式运行查询语句的权限</li>
</ul>
<h3 id="5-1-7-Secrets"><a href="#5-1-7-Secrets" class="headerlink" title="5.1.7 Secrets"></a>5.1.7 Secrets</h3><h3 id="5-1-8-Denial-of-Service"><a href="#5-1-8-Denial-of-Service" class="headerlink" title="5.1.8 Denial of Service"></a>5.1.8 Denial of Service</h3><h3 id="5-1-9-Libraries"><a href="#5-1-9-Libraries" class="headerlink" title="5.1.9 Libraries"></a>5.1.9 Libraries</h3><h3 id="5-1-10-Build-Process"><a href="#5-1-10-Build-Process" class="headerlink" title="5.1.10 Build Process"></a>5.1.10 Build Process</h3><h3 id="5-1-11-External-audits"><a href="#5-1-11-External-audits" class="headerlink" title="5.1.11 External audits"></a>5.1.11 External audits</h3><h2 id="5-2-Integrations"><a href="#5-2-Integrations" class="headerlink" title="5.2 Integrations"></a>5.2 Integrations</h2><h1 id="6-Instrumenting"><a href="#6-Instrumenting" class="headerlink" title="6.Instrumenting"></a>6.Instrumenting</h1><h1 id="7-Alerting"><a href="#7-Alerting" class="headerlink" title="7.Alerting"></a>7.Alerting</h1><h1 id="8-Best-Practices"><a href="#8-Best-Practices" class="headerlink" title="8.Best Practices"></a>8.Best Practices</h1><h2 id="8-4-Histograms-and-summaries"><a href="#8-4-Histograms-and-summaries" class="headerlink" title="8.4 Histograms and summaries"></a>8.4 Histograms and summaries</h2><h3 id="8-4-1-Library-support"><a href="#8-4-1-Library-support" class="headerlink" title="8.4.1 Library support"></a>8.4.1 Library support</h3><p>官方：go java py ruby</p>
<p>译者注：目前node通过prom-client也可以使用</p>
<h3 id="8-4-2-Count-and-sum-of-observations"><a href="#8-4-2-Count-and-sum-of-observations" class="headerlink" title="8.4.2 Count and sum of observations"></a>8.4.2 Count and sum of observations</h3><p>两者都是样本观察，请求持续时间或者响应大小，观察value，求和，计算平均值</p>
<p>可以使用summaries &amp; histogram计算负值（如温度），且无法使用rate</p>
<p>计算5min中内的请求持续时间，平均值的hisogram or summary</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rate(http_request_duration_seconds_sum[<span class="number">5</span>m])/rate(http_request_duration_seconds_count[<span class="number">5</span>m])</span><br></pre></td></tr></table></figure>
<h3 id="8-4-3-Apdex-score"><a href="#8-4-3-Apdex-score" class="headerlink" title="8.4.3 Apdex score"></a>8.4.3 Apdex score</h3><p>Apex =Application Performance Index</p>
<h3 id="8-4-4-Quantiles"><a href="#8-4-4-Quantiles" class="headerlink" title="8.4.4 Quantiles"></a>8.4.4 Quantiles</h3><h3 id="8-4-5-Errors-of-quantile-estimation"><a href="#8-4-5-Errors-of-quantile-estimation" class="headerlink" title="8.4.5 Errors of quantile estimation"></a>8.4.5 Errors of quantile estimation</h3><h3 id="8-4-6-if-no-library-support"><a href="#8-4-6-if-no-library-support" class="headerlink" title="8.4.6 if no library support"></a>8.4.6 if no library support</h3><h1 id="9-Guides"><a href="#9-Guides" class="headerlink" title="9.Guides"></a>9.Guides</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zehai.info/2020/04/29/2020-04-29-prom-client/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/23207152?s=460&v=4">
      <meta itemprop="name" content="Zhang Zehai">
      <meta itemprop="description" content="会做饭的厨子">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zehai'blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/29/2020-04-29-prom-client/" class="post-title-link" itemprop="url">prom-client</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-29 16:18:55" itemprop="dateCreated datePublished" datetime="2020-04-29T16:18:55+08:00">2020-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-30 09:33:31" itemprop="dateModified" datetime="2020-05-30T09:33:31+08:00">2020-05-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/prometheus/" itemprop="url" rel="index"><span itemprop="name">prometheus</span></a>
                </span>
            </span>

          
            <span id="/2020/04/29/2020-04-29-prom-client/" class="post-meta-item leancloud_visitors" data-flag-title="prom-client" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/04/29/2020-04-29-prom-client/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/04/29/2020-04-29-prom-client/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>prom-client 支持nodejs收集metrics，直方图histogram，summaries，gauges，和counters</p>
<p>prometheus通过pull获取node服务数据</p>
<h2 id="支持cluster"><a href="#支持cluster" class="headerlink" title="支持cluster"></a>支持cluster</h2><h1 id="API"><a href="#API" class="headerlink" title="API"></a>API</h1><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>所有metric有两个必填参数，name与help</p>
<h2 id="默认"><a href="#默认" class="headerlink" title="默认"></a>默认</h2><p>1.<code>collectDefaultMetrics</code>为prom推荐metric（部分metric仅在linux生效）</p>
<p>2.包含node特有的metric，如eventLoop lag，active handles，gc，node version</p>
<p>3.collectDefaultMetrics可以接受以下参数</p>
<ul>
<li>prefix：metric自定义前缀，默认空</li>
<li>registry ：自定义注册表，默认global</li>
<li><code>gcDurationBuckets</code></li>
<li><code>eventLoopMonitoringPrecision</code> </li>
</ul>
<h3 id="更换registry"><a href="#更换registry" class="headerlink" title="更换registry"></a>更换registry</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> client = <span class="built_in">require</span>(<span class="string">'prom-client'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> collectDefaultMetrics = client.collectDefaultMetrics;</span><br><span class="line"><span class="keyword">const</span> Registry = client.Registry;</span><br><span class="line"><span class="keyword">const</span> register = <span class="keyword">new</span> Registry();</span><br><span class="line">collectDefaultMetrics(&#123; register &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="To-use-custom-buckets-for-GC-duration-histogram-pass-it-in-as-gcDurationBuckets"><a href="#To-use-custom-buckets-for-GC-duration-histogram-pass-it-in-as-gcDurationBuckets" class="headerlink" title="To use custom buckets for GC duration histogram, pass it in as gcDurationBuckets:"></a>To use custom buckets for GC duration histogram, pass it in as <code>gcDurationBuckets</code>:</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> client = <span class="built_in">require</span>(<span class="string">'prom-client'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> collectDefaultMetrics = client.collectDefaultMetrics;</span><br><span class="line"></span><br><span class="line">collectDefaultMetrics(&#123; <span class="attr">gcDurationBuckets</span>: [<span class="number">0.1</span>, <span class="number">0.2</span>, <span class="number">0.3</span>] &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="To-prefix-metric-names-with-your-own-arbitrary-string-pass-in-a-prefix"><a href="#To-prefix-metric-names-with-your-own-arbitrary-string-pass-in-a-prefix" class="headerlink" title="To prefix metric names with your own arbitrary string, pass in a prefix:"></a>To prefix metric names with your own arbitrary string, pass in a <code>prefix</code>:</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> client = <span class="built_in">require</span>(<span class="string">'prom-client'</span>);</span><br><span class="line"><span class="keyword">const</span> collectDefaultMetrics = client.collectDefaultMetrics;</span><br><span class="line"><span class="keyword">const</span> prefix = <span class="string">'my_application_'</span>;</span><br><span class="line">collectDefaultMetrics(&#123; prefix &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="You-can-get-the-full-list-of-metrics-by-inspecting-client-collectDefaultMetrics-metricsList"><a href="#You-can-get-the-full-list-of-metrics-by-inspecting-client-collectDefaultMetrics-metricsList" class="headerlink" title="You can get the full list of metrics by inspecting client.collectDefaultMetrics.metricsList."></a>You can get the full list of metrics by inspecting <code>client.collectDefaultMetrics.metricsList</code>.</h3><p>Default metrics are collected on scrape of metrics endpoint, not on an interval.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> client = <span class="built_in">require</span>(<span class="string">'prom-client'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> collectDefaultMetrics = client.collectDefaultMetrics;</span><br><span class="line"></span><br><span class="line">collectDefaultMetrics();</span><br></pre></td></tr></table></figure>
<h1 id="counter"><a href="#counter" class="headerlink" title="counter"></a>counter</h1><h1 id="Gauge"><a href="#Gauge" class="headerlink" title="Gauge"></a>Gauge</h1><h1 id="Histogram"><a href="#Histogram" class="headerlink" title="Histogram"></a>Histogram</h1><h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><h1 id="Labels"><a href="#Labels" class="headerlink" title="Labels"></a>Labels</h1><h1 id="Multiple-registries"><a href="#Multiple-registries" class="headerlink" title="Multiple registries"></a>Multiple registries</h1><h1 id="Register"><a href="#Register" class="headerlink" title="Register"></a>Register</h1><h1 id="Pushgateway"><a href="#Pushgateway" class="headerlink" title="Pushgateway"></a>Pushgateway</h1><h1 id="Utilities"><a href="#Utilities" class="headerlink" title="Utilities"></a>Utilities</h1><h1 id="GC-stats"><a href="#GC-stats" class="headerlink" title="GC stats"></a>GC stats</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zehai.info/2020/04/22/2020-04-22-Node14/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/23207152?s=460&v=4">
      <meta itemprop="name" content="Zhang Zehai">
      <meta itemprop="description" content="会做饭的厨子">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zehai'blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/22/2020-04-22-Node14/" class="post-title-link" itemprop="url">Node.JSv14</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-22 10:37:29" itemprop="dateCreated datePublished" datetime="2020-04-22T10:37:29+08:00">2020-04-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-30 09:33:31" itemprop="dateModified" datetime="2020-05-30T09:33:31+08:00">2020-05-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Node/" itemprop="url" rel="index"><span itemprop="name">Node</span></a>
                </span>
            </span>

          
            <span id="/2020/04/22/2020-04-22-Node14/" class="post-meta-item leancloud_visitors" data-flag-title="Node.JSv14" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/04/22/2020-04-22-Node14/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/04/22/2020-04-22-Node14/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="new"><a href="#new" class="headerlink" title="new"></a>new</h1><p>今天看到Node Current更新了14的版本，看看都有些什么东西</p>
<p>前置了解了一下doc中提到的semver，是一个语义化版本semantic versioning，实现版本和版本规范的解析，计算，比较，用以解决在大型项目中对依赖的版本失去控制的问题，Node.js 的包管理工具 npm 也完全基于 Semantic Versioning 来管理依赖的版本。</p>
<p>参考资料：<a href="https://zhuanlan.zhihu.com/p/20747196" target="_blank" rel="noopener">semver：语义化版本规范在 Node.js 中的实现</a></p>
<h2 id="deprecations"><a href="#deprecations" class="headerlink" title="deprecations"></a>deprecations</h2><p>sermver弃用一部分功能</p>
<ul>
<li><strong>(SEMVER-MAJOR)</strong> <strong>crypto</strong>: move pbkdf2 without digest to EOL (James M Snell) </li>
<li><strong>(SEMVER-MAJOR)</strong> <strong>fs</strong>: deprecate closing FileHandle on garbage collection (James M Snell)</li>
<li><strong>(SEMVER-MAJOR)</strong> <strong>http</strong>: move OutboundMessage.prototype.flush to EOL (James M Snell)</li>
<li><strong>(SEMVER-MAJOR)</strong> <strong>lib</strong>: move GLOBAL and root aliases to EOL (James M Snell)</li>
<li><strong>(SEMVER-MAJOR)</strong> <strong>os</strong>: move tmpDir() to EOL (James M Snell) </li>
<li><strong>(SEMVER-MAJOR)</strong> <strong>src</strong>: remove deprecated wasm type check (Clemens Backes) </li>
<li><strong>(SEMVER-MAJOR)</strong> <strong>stream</strong>: move _writableState.buffer to EOL (James M Snell)</li>
<li><strong>(SEMVER-MINOR)</strong> <strong>doc</strong>: deprecate process.mainModule (Antoine du HAMEL)</li>
<li><strong>(SEMVER-MINOR)</strong> <strong>doc</strong>: deprecate process.umask() with no arguments (Colin Ihrig) </li>
</ul>
<h2 id="ECMAScript-Modules"><a href="#ECMAScript-Modules" class="headerlink" title="ECMAScript Modules"></a>ECMAScript Modules</h2><p>在 <code>v13</code> 中，需要调用 <code>--experimental-modules</code> 来开启 <code>ESM module</code> 支持， 而且还会有警告，但目前已经移除警告（还是需要手动开启）<br>仍在实验中，但是其已经非常完善，移除警告迈向了stable的重要一步</p>
<h2 id="New-V8-ArrayBuffer-API"><a href="#New-V8-ArrayBuffer-API" class="headerlink" title="New V8 ArrayBuffer API"></a>New V8 ArrayBuffer API</h2><p>v8不再支持多个ArrayBuffer指向相同的base address</p>
<h2 id="Toolchain-and-Compiler-Upgrades"><a href="#Toolchain-and-Compiler-Upgrades" class="headerlink" title="Toolchain and Compiler Upgrades"></a>Toolchain and Compiler Upgrades</h2><p>//没看懂</p>
<ul>
<li><strong>(SEMVER-MAJOR)</strong> <strong>build</strong>: update macos deployment target to 10.13 for 14.x (AshCripps) <a href="https://github.com/nodejs/node/pull/32454" target="_blank" rel="noopener">#32454</a></li>
<li><strong>(SEMVER-MAJOR)</strong> <strong>doc</strong>: update cross compiler machine for Linux armv7 (Richard Lau) <a href="https://github.com/nodejs/node/pull/32812" target="_blank" rel="noopener">#32812</a></li>
<li><strong>(SEMVER-MAJOR)</strong> <strong>doc</strong>: update Centos/RHEL releases use devtoolset-8 (Richard Lau) <a href="https://github.com/nodejs/node/pull/32812" target="_blank" rel="noopener">#32812</a></li>
<li><strong>(SEMVER-MAJOR)</strong> <strong>doc</strong>: remove SmartOS from official binaries (Richard Lau) <a href="https://github.com/nodejs/node/pull/32812" target="_blank" rel="noopener">#32812</a></li>
<li><strong>(SEMVER-MAJOR)</strong> <strong>win</strong>: block running on EOL Windows versions (João Reis) <a href="https://github.com/nodejs/node/pull/31954" target="_blank" rel="noopener">#31954</a></li>
</ul>
<p>It is expected that there will be an ABI mismatch on ARM between the Node.js binary and native addons. Native addons are only broken if they interact with <code>std::shared_ptr</code>. This is expected to be fixed in a later version of Node.js 14.</p>
<h2 id="Update-to-V8-8-1"><a href="#Update-to-V8-8-1" class="headerlink" title="Update to V8 8.1"></a>Update to V8 8.1</h2><h2 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h2><ul>
<li><strong>cli, report</strong>: move –report-on-fatalerror to stable (Colin Ihrig) </li>
<li><strong>deps</strong>: upgrade to libuv 1.37.0 (Colin Ihrig) </li>
<li><strong>fs</strong>: add fs/promises alias module </li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zehai.info/2020/04/21/2020-04-21-kubenates/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/23207152?s=460&v=4">
      <meta itemprop="name" content="Zhang Zehai">
      <meta itemprop="description" content="会做饭的厨子">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zehai'blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/21/2020-04-21-kubenates/" class="post-title-link" itemprop="url">kubernetes</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-21 16:18:55" itemprop="dateCreated datePublished" datetime="2020-04-21T16:18:55+08:00">2020-04-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-30 09:40:04" itemprop="dateModified" datetime="2020-05-30T09:40:04+08:00">2020-05-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/kubernetes/" itemprop="url" rel="index"><span itemprop="name">kubernetes</span></a>
                </span>
            </span>

          
            <span id="/2020/04/21/2020-04-21-kubenates/" class="post-meta-item leancloud_visitors" data-flag-title="kubernetes" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/04/21/2020-04-21-kubenates/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/04/21/2020-04-21-kubenates/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="2-Basic"><a href="#2-Basic" class="headerlink" title="2.Basic"></a>2.Basic</h1><h2 id="2-1-创建集群"><a href="#2-1-创建集群" class="headerlink" title="2.1 创建集群"></a>2.1 创建集群</h2><p>minikube create</p>
<h2 id="2-2-部署应用"><a href="#2-2-部署应用" class="headerlink" title="2.2 部署应用"></a>2.2 部署应用</h2><p>一旦运行了 Kubernetes 集群，就可以在其上部署容器化应用程序。 为此，您需要创建 Kubernetes <strong>Deployment</strong> 配置。Deployment <strong>指挥 Kubernetes 如何创建和更新应用程序的实例</strong>。创建 Deployment 后，Kubernetes master 将应用程序实例调度到集群中的各个节点上。</p>
<p>创建应用程序实例后，Kubernetes Deployment 控制器会持续监视这些实例。 如果托管实例的节点关闭或被删除，则 Deployment 控制器会将该实例替换为群集中另一个节点上的实例。 <strong>这提供了一种自我修复机制来解决机器故障维护问题。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment kubernetes-bootcamp --image=gcr.io/google-samples/kubernetes-bootcamp:v1</span><br></pre></td></tr></table></figure>
<h2 id="2-3-了解应用"><a href="#2-3-了解应用" class="headerlink" title="2.3 了解应用"></a>2.3 了解应用</h2><p>Kubernates pods（工作节点）</p>
<p>创建 Deployment 时, Kubernetes 添加了一个 <strong>Pod</strong> 来托管你的应用实例。Pod 是 Kubernetes 抽象出来的，表示一组一个或多个应用程序容器（如 Docker 或 rkt ），以及这些容器的一些共享资源。这些资源包括:</p>
<ul>
<li>共享存储，当作卷</li>
<li>网络，作为唯一的集群 IP 地址</li>
<li>有关每个容器如何运行的信息，例如容器映像版本或要使用的特定端口。</li>
</ul>
<p>Pod 为特定于应用程序的“逻辑主机”建模，并且可以包含相对紧耦合的不同应用容器。例如，Pod 可能既包含带有 Node.js 应用的容器，也包含另一个不同的容器，用于提供 Node.js 网络服务器要发布的数据。Pod 中的容器共享 IP 地址和端口，始终位于同一位置并且共同调度，并在同一工作节点上的共享上下文中运行。</p>
<h2 id="2-4-暴露应用"><a href="#2-4-暴露应用" class="headerlink" title="2.4 暴露应用"></a>2.4 暴露应用</h2><h2 id="2-5-伸缩应用"><a href="#2-5-伸缩应用" class="headerlink" title="2.5 伸缩应用"></a>2.5 伸缩应用</h2><h2 id="2-6-更新应用"><a href="#2-6-更新应用" class="headerlink" title="2.6 更新应用"></a>2.6 更新应用</h2><h1 id="3-在线培训课程"><a href="#3-在线培训课程" class="headerlink" title="3.在线培训课程"></a>3.在线培训课程</h1><h1 id="4-配置"><a href="#4-配置" class="headerlink" title="4. 配置"></a>4. 配置</h1><h1 id="5-无状态应用"><a href="#5-无状态应用" class="headerlink" title="5.无状态应用"></a>5.无状态应用</h1><h1 id="6-有状态应用"><a href="#6-有状态应用" class="headerlink" title="6.有状态应用"></a>6.有状态应用</h1><h1 id="7-集群"><a href="#7-集群" class="headerlink" title="7.集群"></a>7.集群</h1><h1 id="8-Service"><a href="#8-Service" class="headerlink" title="8.Service"></a>8.Service</h1>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zehai.info/2020/04/19/2020-04-19-LeetCodeWeek1/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/23207152?s=460&v=4">
      <meta itemprop="name" content="Zhang Zehai">
      <meta itemprop="description" content="会做饭的厨子">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zehai'blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/19/2020-04-19-LeetCodeWeek1/" class="post-title-link" itemprop="url">LeetCodeWeek2</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-19 13:23:52" itemprop="dateCreated datePublished" datetime="2020-04-19T13:23:52+08:00">2020-04-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-30 09:33:31" itemprop="dateModified" datetime="2020-05-30T09:33:31+08:00">2020-05-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/LeetCode/" itemprop="url" rel="index"><span itemprop="name">LeetCode</span></a>
                </span>
            </span>

          
            <span id="/2020/04/19/2020-04-19-LeetCodeWeek1/" class="post-meta-item leancloud_visitors" data-flag-title="LeetCodeWeek2" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/04/19/2020-04-19-LeetCodeWeek1/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/04/19/2020-04-19-LeetCodeWeek1/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Problem-Product-of-Array-Except-Self"><a href="#Problem-Product-of-Array-Except-Self" class="headerlink" title="Problem Product of Array Except Self"></a>Problem Product of Array Except Self</h1><p>Given an array <code>nums</code> of <em>n</em> integers where <em>n</em> &gt; 1,  return an array <code>output</code> such that <code>output[i]</code> is equal to the product of all the elements of <code>nums</code> except <code>nums[i]</code>.</p>
<p><strong>Example:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input:  [1,2,3,4]</span><br><span class="line">Output: [24,12,8,6]</span><br></pre></td></tr></table></figure>
<p><strong>Constraint:</strong> It’s guaranteed that the product of the elements of any prefix or suffix of the array (including the whole array) fits in a 32 bit integer.</p>
<p><strong>Note:</strong> Please solve it <strong>without division</strong> and in O(<em>n</em>).</p>
<p><strong>Follow up:</strong><br>Could you solve it with constant space complexity? (The output array <strong>does not</strong> count as extra space for the purpose of space complexity analysis.)</p>
<h2 id="key"><a href="#key" class="headerlink" title="key"></a>key</h2><h2 id="solution"><a href="#solution" class="headerlink" title="solution"></a>solution</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">//3ms</span><br><span class="line">class Solution &#123;</span><br><span class="line">    public int[] productExceptSelf(int[] nums) &#123;</span><br><span class="line">        int sum =1;</span><br><span class="line">        int hasZero =0;</span><br><span class="line">        for(int num :nums)&#123;</span><br><span class="line">            if(num!=0)&#123;</span><br><span class="line">                sum*=num;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                hasZero++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for(int i=0;i&lt;nums.length;i++)&#123;</span><br><span class="line">            if(hasZero&gt;=2)&#123;</span><br><span class="line">                nums[i]=0;</span><br><span class="line">            &#125;else if(hasZero==1)&#123;</span><br><span class="line">                if(nums[i]==0)&#123;</span><br><span class="line">                    nums[i]=sum;</span><br><span class="line">                &#125;else&#123;</span><br><span class="line">                    nums[i]=0;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;else&#123;</span><br><span class="line">                nums[i]=sum/nums[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return nums;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//1ms</span><br><span class="line">class Solution &#123;</span><br><span class="line">    public int[] productExceptSelf(int[] nums) &#123;</span><br><span class="line">        int n = nums.length;</span><br><span class="line">        int[] left = new int[n];</span><br><span class="line">        left[0] = 1;</span><br><span class="line">        for (int i = 1; i &lt; n; i++) &#123;</span><br><span class="line">            left[i] = left[i-1] * nums[i-1];</span><br><span class="line">        &#125;</span><br><span class="line">        int product = 1;</span><br><span class="line">        for (int i = n - 1; i &gt;= 0; i--) &#123;</span><br><span class="line">            left[i] *= product;</span><br><span class="line">            product *= nums[i];</span><br><span class="line">        &#125;</span><br><span class="line">        return left;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="Problem-678Valid-Parenthesis-String"><a href="#Problem-678Valid-Parenthesis-String" class="headerlink" title="Problem-678Valid Parenthesis String"></a>Problem-678Valid Parenthesis String</h1><p><strong>Medium</strong></p>
<p>Given a string containing only three types of characters: ‘(‘, ‘)’ and ‘*’, write a function to check whether this string is valid. We define the validity of a string by these rules:</p>
<ol>
<li>Any left parenthesis <code>&#39;(&#39;</code> must have a corresponding right parenthesis <code>&#39;)&#39;</code>.</li>
<li>Any right parenthesis <code>&#39;)&#39;</code> must have a corresponding left parenthesis <code>&#39;(&#39;</code>.</li>
<li>Left parenthesis <code>&#39;(&#39;</code> must go before the corresponding right parenthesis <code>&#39;)&#39;</code>.</li>
<li><code>&#39;*&#39;</code> could be treated as a single right parenthesis <code>&#39;)&#39;</code> or a single left parenthesis <code>&#39;(&#39;</code> or an empty string.</li>
<li>An empty string is also valid.</li>
</ol>
<p><strong>Example 1:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;()&quot;</span><br><span class="line">Output: True</span><br></pre></td></tr></table></figure>
<p><strong>Example 2:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;(*)&quot;</span><br><span class="line">Output: True</span><br></pre></td></tr></table></figure>
<p><strong>Example 3:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: &quot;(*))&quot;</span><br><span class="line">Output: True</span><br></pre></td></tr></table></figure>
<p><strong>Note:</strong></p>
<ol>
<li>The string size will be in the range [1, 100].</li>
</ol>
<h2 id="key-1"><a href="#key-1" class="headerlink" title="key"></a>key</h2><h2 id="solution-1"><a href="#solution-1" class="headerlink" title="solution"></a>solution</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkValidString</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (s.length() == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">int</span> left = <span class="number">0</span>;<span class="keyword">int</span> star=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">char</span>[] c = s.toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> i : c) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (i) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'('</span>:</span><br><span class="line">                    left++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">')'</span>:</span><br><span class="line">                    left--;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'*'</span>:</span><br><span class="line">                    star++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (left == <span class="number">0</span> || left - star == <span class="number">0</span> || left + star == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Brute-Force"><a href="#Brute-Force" class="headerlink" title="Brute Force"></a>Brute Force</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> ans = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkValidString</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        solve(<span class="keyword">new</span> StringBuilder(s), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">return</span> ans;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">solve</span><span class="params">(StringBuilder sb, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (i == sb.length()) &#123;</span><br><span class="line">            ans |= valid(sb);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (sb.charAt(i) == <span class="string">'*'</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">char</span> c: <span class="string">"() "</span>.toCharArray()) &#123;</span><br><span class="line">                sb.setCharAt(i, c);</span><br><span class="line">                solve(sb, i+<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (ans) <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            sb.setCharAt(i, <span class="string">'*'</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">            solve(sb, i + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">valid</span><span class="params">(StringBuilder sb)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> bal = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; sb.length(); i++) &#123;</span><br><span class="line">            <span class="keyword">char</span> c = sb.charAt(i);</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="string">'('</span>) bal++;</span><br><span class="line">            <span class="keyword">if</span> (c == <span class="string">')'</span>) bal--;</span><br><span class="line">            <span class="keyword">if</span> (bal &lt; <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bal == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Dynamic-Programming"><a href="#Dynamic-Programming" class="headerlink" title="Dynamic Programming"></a>Dynamic Programming</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkValidString</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> n = s.length();</span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">boolean</span>[][] dp = <span class="keyword">new</span> <span class="keyword">boolean</span>[n][n];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; n; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (s.charAt(i) == <span class="string">'*'</span>) dp[i][i] = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (i &lt; n-<span class="number">1</span> &amp;&amp;</span><br><span class="line">                    (s.charAt(i) == <span class="string">'('</span> || s.charAt(i) == <span class="string">'*'</span>) &amp;&amp;</span><br><span class="line">                    (s.charAt(i+<span class="number">1</span>) == <span class="string">')'</span> || s.charAt(i+<span class="number">1</span>) == <span class="string">'*'</span>)) &#123;</span><br><span class="line">                dp[i][i+<span class="number">1</span>] = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> size = <span class="number">2</span>; size &lt; n; size++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i + size &lt; n; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (s.charAt(i) == <span class="string">'*'</span> &amp;&amp; dp[i+<span class="number">1</span>][i+size] == <span class="keyword">true</span>) &#123;</span><br><span class="line">                    dp[i][i+size] = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (s.charAt(i) == <span class="string">'('</span> || s.charAt(i) == <span class="string">'*'</span>) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> k = i+<span class="number">1</span>; k &lt;= i+size; k++) &#123;</span><br><span class="line">                        <span class="keyword">if</span> ((s.charAt(k) == <span class="string">')'</span> || s.charAt(k) == <span class="string">'*'</span>) &amp;&amp;</span><br><span class="line">                                (k == i+<span class="number">1</span> || dp[i+<span class="number">1</span>][k-<span class="number">1</span>]) &amp;&amp;</span><br><span class="line">                                (k == i+size || dp[k+<span class="number">1</span>][i+size])) &#123;</span><br><span class="line">                            dp[i][i+size] = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> dp[<span class="number">0</span>][n-<span class="number">1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Greedy"><a href="#Greedy" class="headerlink" title="Greedy"></a>Greedy</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkValidString</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> lo = <span class="number">0</span>, hi = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">char</span> c: s.toCharArray()) &#123;</span><br><span class="line">           lo += c == <span class="string">'('</span> ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">           hi += c != <span class="string">')'</span> ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">           <span class="keyword">if</span> (hi &lt; <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">           lo = Math.max(lo, <span class="number">0</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> lo == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope="" itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="http://zehai.info/2020/04/16/2020-04-16-同一宿主机下docker互相访问/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars3.githubusercontent.com/u/23207152?s=460&v=4">
      <meta itemprop="name" content="Zhang Zehai">
      <meta itemprop="description" content="会做饭的厨子">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zehai'blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/16/2020-04-16-同一宿主机下docker互相访问/" class="post-title-link" itemprop="url">同一宿主机下docker互相访问</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-16 18:06:19" itemprop="dateCreated datePublished" datetime="2020-04-16T18:06:19+08:00">2020-04-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-05-30 09:33:31" itemprop="dateModified" datetime="2020-05-30T09:33:31+08:00">2020-05-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/Question/" itemprop="url" rel="index"><span itemprop="name">Question</span></a>
                </span>
            </span>

          
            <span id="/2020/04/16/2020-04-16-同一宿主机下docker互相访问/" class="post-meta-item leancloud_visitors" data-flag-title="同一宿主机下docker互相访问" title="Views">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine: </span>
    
    <a title="valine" href="/2020/04/16/2020-04-16-同一宿主机下docker互相访问/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2020/04/16/2020-04-16-同一宿主机下docker互相访问/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="what"><a href="#what" class="headerlink" title="what"></a>what</h1><p>该文档解决：docker下，altermanager收不到prometheus消息</p>
<p>事因，我在一个宿主机下建立了多个docker容器</p>
<ul>
<li>node-exporter</li>
<li>prometheus</li>
<li>grafana</li>
<li>alertmanager</li>
<li>timonwong/prometheus-webhook-dingtalk</li>
</ul>
<p>这些服务之间会有一些互相访问，如prometheus可以发送数据给alertmanager来发送报警信息，alertmanager通过规则处理可以发送邮件，发送钉钉等方式告知用户，问题就出在prometheus的yml配置文档中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets: ['localhost:9002']  </span><br><span class="line">        </span><br><span class="line"><span class="meta">#</span>##############</span><br><span class="line">修改后：</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">    - static_configs:</span><br><span class="line">        - targets: ['10.10.10.10:9002']</span><br></pre></td></tr></table></figure>
<p>问题出在了prometheus的配置中访问了localhost端口，但这个并不是访问宿主机的9002的端口，而是访问的是<code>docker内部的9002</code>端口</p>
<p>找到问题后，使用了宿主机ip+port的方式进行访问</p>
<h1 id="how"><a href="#how" class="headerlink" title="how"></a>how</h1><p>查询了资料后，发现解决该问题的方法有：</p>
<ul>
<li>宿主ip：port访问</li>
<li>容器ip访问</li>
<li>link建立通信网络(单向，不推荐)–link xxx</li>
<li>user-defined networks（docker dns server/bridge）</li>
</ul>
<p>前两种不太推荐，因为如果容器ip更改或者宿主机ip更改就需要更新配置文档，第三种方法不太推荐，run 时候link只是单向的建立连接，第四种<a href="https://docs.docker.com/engine/reference/commandline/network_create/" target="_blank" rel="noopener">docker network create</a>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//创建网络</span><br><span class="line">docker network create -d bridge my-bridge-network</span><br><span class="line">//run时候加入网络</span><br><span class="line">docker run -it --network test-network --network-alias mysql  -e MYSQL_ROOT_PASSWORD=123 mysql:5.7</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Zhang Zehai" src="https://avatars3.githubusercontent.com/u/23207152?s=460&v=4">
  <p class="site-author-name" itemprop="name">Zhang Zehai</p>
  <div class="site-description" itemprop="description">会做饭的厨子</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">94</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">29</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">28</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ShawnGoethe" title="GitHub → https://github.com/ShawnGoethe" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/zehaizhang@aliyun.com" title="E-Mail → zehaizhang@aliyun.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://barriery.cn/" title="https://barriery.cn/" rel="noopener" target="_blank">barriery</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://learngitbranching.js.org/" title="https://learngitbranching.js.org/" rel="noopener" target="_blank">git-newer</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://regexone.com/" title="https://regexone.com/" rel="noopener" target="_blank">regex-newer</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://sqlzoo.net/" title="https://sqlzoo.net/" rel="noopener" target="_blank">sql-newer</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
    <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=298 height=52 src="//music.163.com/outchain/player?type=2&id=1385126398&auto=0&height=32"></iframe>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhang Zehai</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.2
  </div>

        






  <script>
  function leancloudSelector(url) {
    url = encodeURI(url);
    return document.getElementById(url).querySelector('.leancloud-visitors-count');
  }
  if (CONFIG.page.isPost) {
    function addCount(Counter) {
      var visitors = document.querySelector('.leancloud_visitors');
      var url = decodeURI(visitors.getAttribute('id'));
      var title = visitors.dataset.flagTitle;

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length > 0) {
            var counter = results[0];
            Counter('put', '/classes/Counter/' + counter.objectId, { time: { '__op': 'Increment', 'amount': 1 } })
              .then(response => response.json())
              .then(() => {
                leancloudSelector(url).innerText = counter.time + 1;
              })
              .catch(error => {
                console.error('Failed to save visitor count', error);
              })
          } else {
              leancloudSelector(url).innerText = 'Counter not initialized! More info at console err msg.';
              console.error('ATTENTION! LeanCloud counter has security bug, see how to solve it here: https://github.com/theme-next/hexo-leancloud-counter-security. \n However, you can still use LeanCloud without security, by setting `security` option to `false`.');
            
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  } else {
    function showTime(Counter) {
      var visitors = document.querySelectorAll('.leancloud_visitors');
      var entries = [...visitors].map(element => {
        return decodeURI(element.getAttribute('id'));
      });

      Counter('get', `/classes/Counter?where=${JSON.stringify({ url: { '$in': entries } })}`)
        .then(response => response.json())
        .then(({ results }) => {
          if (results.length === 0) {
            document.querySelectorAll('.leancloud_visitors .leancloud-visitors-count').forEach(element => {
              element.innerText = 0;
            });
            return;
          }
          for (let item of results) {
            let { url, time } = item;
            leancloudSelector(url).innerText = time;
          }
          for (let url of entries) {
            var element = leancloudSelector(url);
            if (element.innerText == '') {
              element.innerText = 0;
            }
          }
        })
        .catch(error => {
          console.error('LeanCloud Counter Error', error);
        });
    }
  }

  fetch('https://app-router.leancloud.cn/2/route?appId=pc6nnLuEjNG6bbE4yA4diNOH-gzGzoHsz')
    .then(response => response.json())
    .then(({ api_server }) => {
      var Counter = (method, url, data) => {
        return fetch(`https://${api_server}/1.1${url}`, {
          method,
          headers: {
            'X-LC-Id'     : 'pc6nnLuEjNG6bbE4yA4diNOH-gzGzoHsz',
            'X-LC-Key'    : '7wLVv3rk9lEybmPjgAWD4jwl',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data)
        });
      };
      if (CONFIG.page.isPost) {
        if (CONFIG.hostname !== location.hostname) return;
        addCount(Counter);
      } else if (document.querySelectorAll('.post-title-link').length >= 1) {
        showTime(Counter);
      }
    });
  </script>


      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'pc6nnLuEjNG6bbE4yA4diNOH-gzGzoHsz',
      appKey     : '7wLVv3rk9lEybmPjgAWD4jwl',
      placeholder: "please leave your suggestion",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
